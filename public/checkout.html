<script src="https://js.yoco.com/sdk/v1/yoco-sdk-web.js"></script>

<button id="checkout-button">Pay Now</button>
<div id="payment-result"></div>

<script>
  var yoco = new window.YocoSDK({
    publicKey: "pk_test_d9aa6ae78o809b3e1f84", // replace with your PUBLIC key
  });

  // Pull cart data from localStorage and calculate total
  function getCartTotal() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let total = 0;

    cart.forEach(item => {
      total += item.price * item.quantity; // Adjust keys if your cart structure is different
    });

    return total; // total in Rands
  }

  document.getElementById("checkout-button").addEventListener("click", function () {
    let amountInCents = Math.round(getCartTotal() * 100);

    yoco.showPopup({
      amountInCents: amountInCents,
      currency: "ZAR",
      name: "My Website",
      description: "Cart Payment",
      callback: function (result) {
        if (result.error) {
          document.getElementById("payment-result").innerText =
            "Error: " + result.error.message;
        } else {
          fetch("/netlify/functions/charge.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: result.id, amount: amountInCents }),
          })
            .then(res => res.json())
            .then(data => {
              if (data.status === "successful") {
                document.getElementById("payment-result").innerText = "✅ Payment successful!";
              } else {
                document.getElementById("payment-result").innerText = "❌ Payment failed!";
              }
            });
        }
      },
    });
  });
</script>
